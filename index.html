<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stream7</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#f9f9fb;
      --card:#ffffff;
      --muted:#8b94a3;
      --accent:#0f1724;
      --pill:#ef4444;
      --shadow: 0 6px 18px rgba(12,20,30,0.05);
    }
    html,body{height:100%}
    body{margin:0;font-family:Inter,-apple-system,BlinkMacSystemFont,"SF Pro Text",Roboto,Segoe UI,system-ui,Arial;background:var(--bg);color:#0b1220;-webkit-font-smoothing:antialiased}
    header{position:sticky;top:0;background:var(--card);padding:14px 18px;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;z-index:40}
    .brand{font-weight:700;font-size:18px}
    .search-wrap{padding:14px 16px;display:flex;justify-content:center}
    .search-input{width:100%;max-width:920px;background:#fff;border:1px solid #eef2f6;padding:12px 16px;border-radius:12px;font-size:15px;outline:none;box-shadow:0 1px 0 rgba(12,20,30,0.02)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;padding:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(12,20,30,0.04);display:flex;flex-direction:column;transition:transform .12s}
    .card:hover{transform:translateY(-4px)}
    .thumb-container{position:relative;background:#f1f3f5}
    .thumb-container::before{content:"";display:block;padding-top:56.25%}
    .thumb-content{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .thumb{width:100%;height:100%;object-fit:cover;display:block;border-radius:0}
    .play-prompt{font-weight:700;font-size:16px;color:#222;padding:8px 14px;border-radius:10px;background:rgba(255,255,255,0.8)}
    .info{padding:14px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:600;font-size:16px;color:#0b1220}
    .meta{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;border-radius:10px;padding:7px 12px;border:none;font-size:13px;cursor:pointer}
    .suburl{font-size:12px;color:#888;word-break:break-all;margin-top:8px}
    .badge{background:var(--pill);color:#fff;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .group-head{grid-column:1/-1;padding:10px 14px;border-radius:12px;background:rgba(0,0,0,0.03);font-weight:700;color:#111;margin-bottom:4px}
    .season-head{grid-column:1/-1;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.02);font-weight:700;color:#222;margin-top:6px}
    .empty{padding:40px;text-align:center;color:var(--muted)}
    @media (max-width:520px){ .title{font-size:15px} .play-prompt{font-size:15px} .btn{padding:6px 10px} }
  </style>
</head>
<body>
  <header><div class="brand">Stream7</div></header>
  <div class="search-wrap">
    <input id="searchInput" class="search-input" placeholder="Rechercher par nom, saison, épisode, URL..." />
  </div>
  <main>
    <div id="fileList" class="grid"></div>
    <div id="emptyMessage" class="empty" style="display:none">Aucun fichier trouvé.</div>
  </main>

  <script>
  (function(){
    var CONFIG = {
      FILES_PATH: 'https://adamdhaiti.tergenedhaiti.workers.dev/get-all',
      POLL_INTERVAL_MS: 12000,
      PRESERVE_PLAY_MS: 3000,
      CHUNK_SIZE: 50,
      MAX_RENDER: 1500,
      METADATA_CAP: 30000,
      MAX_VIDEOS_RENDER: 8,
      SHOW_NO_THUMB_TEXT: 'Cliquez pour jouer'
    };

    function toNum(v){ return (v===undefined||v===null)?0:Number(v)||0; }
    function normalizeString(s){ if(!s) return ''; try{ s = s.normalize('NFKD').replace(/[\u0300-\u036f]/g,''); }catch(e){} try{ s = s.replace(/[^\p{L}\p{N}]+/gu,' '); }catch(e){ s = s.replace(/[^A-Za-z0-9]+/g,' '); } return s.replace(/\s+/g,' ').trim().toLowerCase(); }
    function normalizeKeyName(k){ if(!k) return ''; var s = String(k||''); try{ s = decodeURIComponent(s); }catch(e){} s = s.replace(/^\/+/, ''); s = s.replace(/^uploads\//i, ''); s = s.replace(/uploads%2F/i, ''); return s.trim(); }
    function getPathname(u){ if(!u) return ''; try { var tmp = new URL(u, location.origin); return tmp.pathname || u; } catch(e) { return (u+'').split('?')[0].split('#')[0]; } }
    function isImageFile(nameOrUrl){ var p = getPathname(nameOrUrl).toLowerCase(); return !!p.match(/\.(jpg|jpeg|png|gif|webp|bmp|heic)$/i); }
    function isVideoFile(nameOrUrl){ var p = getPathname(nameOrUrl).toLowerCase(); return !!p.match(/\.(mp4|mov|webm|m4v|mkv)$/i); }
    function removeBrackets(s){ if(!s) return s; return s.replace(/[\{\}]/g,' ').replace(/\s+/g,' ').trim(); }

    function detectTrailingTwoNumbersFromName(noExt){
      if(!noExt) return null;
      var s = (noExt+'').replace(/[_\.\u2013\u2014\-]+/g,' ').replace(/\s+/g,' ').trim();
      var parts = s.split(/\s+/).filter(Boolean);
      if(parts.length === 0) return null;
      var noiseRe = /^(ep|episode|e|s|season|saison|vf|vostfr|vost|sub|dub|x264|x265|h264|hevc|hdrip|bdrip|webrip|web|bluray|bd|dvdrip|px|eng|fr|jp|720p|1080p|2160p|4k|8k)$/i;

      var lastAlpha = -1;
      for(var i=0;i<parts.length;i++){
        if(/\p{L}/u.test(parts[i])) lastAlpha = i;
      }

      function extractNumsFromTok(tok, out){
        if(/^\d{5,}$/.test(tok)) return; // skip long pure numbers (timestamps)
        var m = tok.match(/\d{1,3}/g);
        if(!m) return;
        for(var j=0;j<m.length && out.length<2;j++){
          var v = Number(m[j]);
          if(!isFinite(v)) continue;
          if(v >= 1000) continue;
          out.push(v);
        }
      }

      if(lastAlpha >= 0){
        var candidates = parts.slice(lastAlpha + 1);
        var found = [];
        for(var k=0;k<candidates.length && found.length<2;k++){
          var tok = candidates[k];
          if(!tok) continue;
          if(noiseRe.test(tok)) continue;
          if(/^\d{1,4}$/.test(tok)){
            var val = Number(tok);
            if(val < 1000) found.push(val);
            continue;
          }
          extractNumsFromTok(tok, found);
        }
        if(found.length >= 2) return [found[0], found[1]];
      }

      var found2 = [];
      for(var ii = parts.length - 1; ii >= 0 && found2.length < 2; ii--){
        var t = parts[ii];
        if(!t) continue;
        if(noiseRe.test(t)) continue;
        if(/^\d{5,}$/.test(t)) continue;
        if(/^\d{1,4}$/.test(t)){
          var vv = Number(t);
          if(vv < 1000) found2.push(vv);
          continue;
        }
        var mm = t.match(/\d{1,3}/g) || [];
        for(var zi = mm.length - 1; zi >= 0 && found2.length < 2; zi--){
          var vv2 = Number(mm[zi]);
          if(!isFinite(vv2) || vv2 >= 1000) continue;
          found2.push(vv2);
        }
      }
      if(found2.length >= 2){
        found2.reverse();
        return [found2[0], found2[1]];
      }

      return null;
    }

    function parseParts(name){
      var original = String(name || '');
      var noExt = original.replace(/\.[^.]+$/,'');
      var rawCandidate = removeBrackets(noExt).replace(/[_\.\u2013\u2014]+/g,' ').trim();
      var raw = rawCandidate.replace(/[-\s]+/g,' ').trim();
      raw = raw.replace(/\b(voiranime|anime|stream|watch|vf|vostfr|vost|fr|sub|dub|x264|x265|720p|1080p|480p|2160p|webrip|bluray)\b/gi,' ').replace(/\s+/g,' ').trim();

      var season = null, ep = null, hasSeason=false, hasEp=false, numericToken = null;

      var m;
      m = raw.match(/(?:\b|^)(?:s|season|saison)\s*0*(\d{1,3})\s*[-_.\s]*[eexX]\s*0*(\d{1,3})(?:\b|$)/i);
      if(m){ season = toNum(m[1]); ep = toNum(m[2]); hasSeason = true; hasEp = true; raw = raw.replace(m[0],' '); }
      if(!hasSeason || !hasEp){
        m = raw.match(/(\d{1,2})[xX]0*(\d{1,3})/);
        if(m){ season = toNum(m[1]); ep = toNum(m[2]); hasSeason = true; hasEp = true; raw = raw.replace(m[0],' '); }
      }
      if(!hasSeason || !hasEp){
        m = raw.match(/(?:season|saison)\s*0*(\d{1,3})\s*(?:ep|episode|e)\s*0*(\d{1,3})/i);
        if(m){ season = toNum(m[1]); ep = toNum(m[2]); hasSeason = true; hasEp = true; raw = raw.replace(m[0],' '); }
      }
      if(!hasEp){
        m = raw.match(/\b(?:ep|episode|e)\.?\s*0*(\d{1,4})\b/i);
        if(m){ ep = toNum(m[1]); hasEp = true; raw = raw.replace(m[0],' '); }
      }
      if(!hasSeason){
        m = raw.match(/\b(?:s|season|saison)\.?\s*0*(\d{1,3})\b/i);
        if(m){ season = toNum(m[1]); hasSeason = true; raw = raw.replace(m[0],' '); }
      }

      if(!hasSeason || !hasEp){
        try{
          var ded = detectTrailingTwoNumbersFromName(noExt);
          if(ded && ded.length === 2){
            season = toNum(ded[0]); ep = toNum(ded[1]); hasSeason = true; hasEp = true;
          }
        }catch(e){}
      }

      raw = raw.replace(/\b\d{8,13}\b/g,' ');
      raw = raw.replace(/\b(?:ep|episode|e|s|season|saison|vostfr|vf|sub|dub)\b/gi,' ');
      raw = raw.replace(/\b\d{1,4}\b/g,' ');
      raw = raw.replace(/\s+/g,' ').trim();

      var base = normalizeString(raw || noExt);
      if(!base) base = normalizeString(noExt.replace(/\b\d{1,4}\b/g,' ').replace(/[_\-\.\u2013\u2014]+/g,' ').trim());

      var numericTokenMatch = noExt.match(/(\d{1,4})(?!.*\d{1,4})/);
      if(numericTokenMatch) numericToken = Number(numericTokenMatch[1]);

      return {
        base: base,
        season: (season != null) ? toNum(season) : null,
        ep: (ep != null) ? toNum(ep) : null,
        numericToken: numericToken != null ? toNum(numericToken) : null,
        hasSeason: !!hasSeason,
        hasEp: !!hasEp,
        raw: raw,
        noExt: noExt
      };
    }

    function tokenJaccard(a,b){ if(!a||!b) return 0; var ta=a.split(/\s+/).filter(Boolean), tb=b.split(/\s+/).filter(Boolean), sa={}, sb={}; ta.forEach(function(t){ if(t.length>1) sa[t]=1 }); tb.forEach(function(t){ if(t.length>1) sb[t]=1 }); var inter=0; for(var k in sa) if(sb[k]) inter++; var union = Object.keys(sa).length + Object.keys(sb).length - inter; if(union===0) return 0; return inter/union; }
    function basesSimilar(a,b){ if(!a||!b) return false; if(a===b) return true; if(a.indexOf(b)!==-1||b.indexOf(a)!==-1) return true; var firstA=a.split(' ')[0], firstB=b.split(' ')[0]; if(firstA && firstB && firstA===firstB) return true; return tokenJaccard(a,b) >= 0.3; }
    function insertSoftBreaks(str,maxLen){ if(!str) return ''; maxLen = maxLen || 40; return str.replace(/\S+/g,function(chunk){ if(chunk.length <= maxLen) return chunk; var out=''; for(var i=0;i<chunk.length;i+=maxLen){ out += chunk.slice(i, i+maxLen); if(i+maxLen<chunk.length) out += '\u200b'; } return out; }); }
    function copyUrl(url){ if(!url) return; if(navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(url).catch(function(){}); else { var ta = document.createElement('textarea'); ta.value = url; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} ta.remove(); } }

    var playingMap = new Map();
    function attachPlaybackTracking(vidEl, url){
      function markPlaying(){ playingMap.set(url, { el: vidEl, lastPlayTs: Date.now(), position: vidEl.currentTime || 0 }); }
      function markPaused(){ var entry = playingMap.get(url) || {}; entry.position = vidEl.currentTime || 0; entry.lastPlayTs = Date.now(); playingMap.set(url, entry); }
      vidEl.addEventListener('play', markPlaying); vidEl.addEventListener('playing', markPlaying); vidEl.addEventListener('pause', markPaused); vidEl.addEventListener('ended', markPaused);
    }

    function createNoThumbPlaceholder(url){
      var wrapper = document.createElement('div'); wrapper.className = 'thumb-container';
      try{ wrapper.dataset.url = url || ''; } catch(e){}
      var content = document.createElement('div'); content.className = 'thumb-content';
      var prompt = document.createElement('div'); prompt.className = 'play-prompt'; prompt.textContent = CONFIG.SHOW_NO_THUMB_TEXT;
      content.appendChild(prompt); wrapper.appendChild(content);
      function onClick(){
        if(!url) return;
        var existing = content.querySelector('video');
        if(existing){ if(existing.paused) existing.play().catch(function(){}); else existing.pause(); return; }
        var vid = document.createElement('video');
        vid.className = 'thumb'; vid.src = url; vid.controls = true; vid.preload = 'metadata'; vid.setAttribute('playsinline','');
        vid.style.width = '100%'; vid.style.height = '100%'; vid.style.objectFit = 'cover';
        attachPlaybackTracking(vid, url);
        content.innerHTML = ''; content.appendChild(vid);
        var p = vid.play(); if(p && p.catch) p.catch(function(){});
      }
      wrapper.addEventListener('click', onClick);
      wrapper.addEventListener('keydown', function(e){ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onClick(); } });
      return wrapper;
    }

    function createCardElement(f){
      if(f.__groupHeader){
        var head = document.createElement('div'); head.className = 'group-head'; head.textContent = (f.base || '(sans nom)').replace(/[_\-\s]+/g,' ').trim(); return head;
      }
      if(f.__seasonHeader){
        var s = document.createElement('div'); s.className = 'season-head'; s.textContent = f.seasonLabel || (f.season === 'base' ? 'Base' : ('Saison ' + f.season)); return s;
      }

      var card = document.createElement('div'); card.className = 'card';
      var isVideo = isVideoFile(f.url || f.name || '');
      var preview;
      if(isVideo){
        preview = createNoThumbPlaceholder(f.url);
        try{ preview.dataset.url = f.url || ''; }catch(e){}
      } else if(isImageFile(f.url || f.name || '')){
        preview = document.createElement('div'); preview.className = 'thumb-container';
        var content = document.createElement('div'); content.className = 'thumb-content';
        var img = document.createElement('img'); img.className = 'thumb'; img.alt = f.name || ''; img.src = f.url; img.loading = 'lazy';
        content.appendChild(img); preview.appendChild(content);
        try{ preview.dataset.url = f.url || ''; }catch(e){}
      } else {
        preview = document.createElement('div'); preview.className = 'thumb-container';
        var content2 = document.createElement('div'); content2.className = 'thumb-content';
        var txt = document.createElement('div'); txt.textContent = 'Pas d’aperçu';
        content2.appendChild(txt); preview.appendChild(content2);
        try{ preview.dataset.url = f.url || ''; }catch(e){}
      }

      try{ var p = parseParts(f.name || ''); card.dataset.base = p.base || ''; card.dataset.season = (f.__displaySeason!=null)?String(f.__displaySeason):((p.season!=null)?String(p.season):''); card.dataset.ep = (f.__displayEp!=null)?String(f.__displayEp):((p.ep!=null)?String(p.ep):''); }catch(e){}

      var info = document.createElement('div'); info.className = 'info';
      var nameRow = document.createElement('div');
      var titleDiv = document.createElement('div'); titleDiv.className = 'title';
      var p2 = parseParts(f.name || '');
      var display = (p2.raw || f.name || '').replace(/[_\-\s]+/g,' ').trim();
      if(f.__displaySeason!=null || f.__displayEp!=null){
        var s = f.__displaySeason != null ? f.__displaySeason : null;
        var e = f.__displayEp != null ? f.__displayEp : null;
        if(s != null && e != null) display = display + ' Saison ' + s + ' ep ' + e;
        else if(s != null) display = display + ' Saison ' + s;
        else if(e != null) display = display + ' ep ' + e;
      } else if(p2.hasSeason || p2.hasEp || p2.season != null || p2.ep != null){
        var s = (p2.season != null) ? p2.season : null;
        var e = (p2.ep != null) ? p2.ep : null;
        if(s != null && e != null) display = display + ' Saison ' + s + ' ep ' + e;
        else if(s != null) display = display + ' Saison ' + s;
        else if(e != null) display = display + ' ep ' + e;
      }
      titleDiv.textContent = display || '(sans nom)';
      nameRow.appendChild(titleDiv);
      info.appendChild(nameRow);

      if(f.__isNewestForEpisode){
        var badge = document.createElement('span'); badge.className = 'badge'; badge.textContent = 'NOUVO'; badge.style.fontSize = '11px'; badge.style.marginLeft = '8px';
        nameRow.appendChild(badge);
      }

      var metaDiv = document.createElement('div'); metaDiv.className = 'meta'; metaDiv.textContent = ((toNum(f.size)||0)/1048576).toFixed(1) + ' MB';
      var actions = document.createElement('div'); actions.className = 'actions';
      var copyBtn = document.createElement('button'); copyBtn.className = 'btn'; copyBtn.textContent = 'Copier URL'; copyBtn.addEventListener('click', function(){ copyUrl(f.url); });
      var openA = document.createElement('a'); openA.href = f.url || '#'; openA.target = '_blank';
      var openBtn = document.createElement('button'); openBtn.className = 'btn'; openBtn.textContent = 'Ouvrir'; openA.appendChild(openBtn);
      var urlSpan = document.createElement('div'); urlSpan.className = 'suburl'; urlSpan.textContent = insertSoftBreaks(f.url || '', 50);
      actions.appendChild(copyBtn); actions.appendChild(openA);
      info.appendChild(metaDiv); info.appendChild(actions); info.appendChild(urlSpan);

      card.appendChild(preview); card.appendChild(info);
      return card;
    }

    function buildOrderedList(files){
      var groups = [];
      (files||[]).forEach(function(f){
        try {
          var p = parseParts(f.name||'');
          var baseKey = p.base || normalizeString((f.name||'').replace(/\.[^.]+$/,'').replace(/\b\d+\b/g,''));
          var placed = false;
          for(var i=0;i<groups.length;i++){
            if(basesSimilar(baseKey, groups[i].base)){
              groups[i].items.push(f); placed = true; break;
            }
          }
          if(!placed) groups.push({ base: baseKey, items: [f] });
        } catch(e){
          var fb = normalizeString((f.name||'').replace(/\.[^.]+$/,'').replace(/\b\d+\b/g,''));
          var placed2 = false;
          for(var j=0;j<groups.length;j++){
            if(basesSimilar(fb, groups[j].base)){
              groups[j].items.push(f); placed2 = true; break;
            }
          }
          if(!placed2) groups.push({ base: fb, items: [f] });
        }
      });

      var groupArr = groups.map(function(g){
        var newest = g.items.reduce(function(m,it){ return Math.max(m, toNum(it.lastModified)); }, 0);
        return { base: g.base, items: g.items, newest: newest, itemCount: g.items.length };
      });

      groupArr.sort(function(a,b){ return Number(b.newest||0) - Number(a.newest||0); });

      var out = [];
      groupArr.forEach(function(g){
        var parsed = g.items.map(function(it){ return { it: it, p: parseParts(it.name||'') }; });

        var explicitSeasons = parsed.filter(function(x){ return x.p.hasSeason && x.p.season!=null; }).map(function(x){ return x.p.season; });
        var explicitSet = {};
        explicitSeasons.forEach(function(s){ explicitSet[s] = true; });
        var maxExplicit = explicitSeasons.length ? Math.max.apply(null, explicitSeasons) : 0;
        var synthSeasonForGroup = (maxExplicit > 0) ? (maxExplicit + 1) : 1;

        var explicitSeasonItems = parsed.filter(function(x){ return x.p.hasSeason || x.p.hasEp; }).map(function(x){ return x.it; });
        var numericOnly = parsed.filter(function(x){ return !x.p.hasSeason && !x.p.hasEp && x.p.numericToken!=null; }).map(function(x){ return x.it; });
        var baseOnly = parsed.filter(function(x){ return !x.p.hasSeason && !x.p.hasEp && x.p.numericToken==null; }).map(function(x){ return x.it; });

        numericOnly.forEach(function(it){
          var p = parseParts(it.name||'');
          var ded = detectTrailingTwoNumbersFromName(p.noExt || it.name || '');
          if(ded && ded.length === 2){
            it.__displaySeason = ded[0];
            it.__displayEp = ded[1];
            return;
          }
          if(p.numericToken != null){
            if(Object.keys(explicitSet).length > 0){
              if(explicitSet[1]) it.__displaySeason = 1;
              else it.__displaySeason = maxExplicit;
              it.__displayEp = p.numericToken;
              return;
            } else {
              it.__displaySeason = synthSeasonForGroup;
              it.__displayEp = p.numericToken;
              return;
            }
          }
        });

        explicitSeasonItems.forEach(function(it){
          var p = parseParts(it.name || '');
          if(p.season != null) it.__displaySeason = p.season;
          else if(p.hasEp && p.season==null && explicitSeasons.length===0) it.__displaySeason = 1;
          else if(p.hasEp && p.season==null && explicitSeasons.length>0) it.__displaySeason = synthSeasonForGroup;
          it.__displayEp = (p.ep != null) ? p.ep : (p.numericToken != null ? p.numericToken : null);
        });

        baseOnly.forEach(function(it){ });

        out.push({ __groupHeader: true, base: g.base, newest: g.newest, itemCount: g.itemCount });

        var seasonMap = {};
        function pushToSeason(sKey, item){ seasonMap[sKey] = seasonMap[sKey] || []; seasonMap[sKey].push(item); }

        parsed.forEach(function(entry){
          var it = entry.it;
          if(it.__displaySeason != null) pushToSeason(String(it.__displaySeason), it);
          else {
            var p = parseParts(it.name || '');
            if(p.season != null) pushToSeason(String(p.season), it);
            else pushToSeason('base', it);
          }
        });

        var seasonKeys = Object.keys(seasonMap).sort(function(a,b){
          if(a === 'base') return 1;
          if(b === 'base') return -1;
          return Number(a) - Number(b);
        });

        seasonKeys.forEach(function(sk){
          out.push({ __seasonHeader: true, season: sk, seasonLabel: (sk === 'base' ? 'Base' : ('Saison ' + sk)) });
          var items = seasonMap[sk] || [];
          var epBuckets = {};
          items.forEach(function(it){
            var p = parseParts(it.name || '');
            var epKey;
            if(it.__displayEp != null) epKey = String(it.__displayEp);
            else if(p.hasEp && p.ep != null) epKey = String(p.ep);
            else epKey = 'base';
            epBuckets[epKey] = epBuckets[epKey] || [];
            epBuckets[epKey].push(it);
          });
          var epKeys = Object.keys(epBuckets).sort(function(a,b){
            if(a === 'base') return 1;
            if(b === 'base') return -1;
            return Number(a) - Number(b);
          });
          epKeys.forEach(function(ek){
            var arr = epBuckets[ek] || [];
            arr.sort(function(x,y){ return toNum(y.lastModified) - toNum(x.lastModified); });
            arr.forEach(function(it, idx){ it.__isNewestForEpisode = (idx === 0); out.push(it); });
          });
        });
      });

      return out;
    }

    function snapshotPlayingVideos(){
      var map = new Map();
      try{
        document.querySelectorAll('#fileList video').forEach(function(v){
          try{
            var src = v.currentSrc || v.src || (v.dataset && v.dataset.url) || '';
            if(!src) return;
            var paused = v.paused || v.ended;
            var now = Date.now();
            var entry = playingMap.get(src) || {};
            var last = entry.lastPlayTs || 0;
            if((!paused) || (now - last <= CONFIG.PRESERVE_PLAY_MS)){
              if(v.parentElement) v.parentElement.removeChild(v);
              map.set(src, { el: v, pos: v.currentTime || (entry.position || 0), lastPlayTs: now });
            }
          }catch(e){}
        });
      }catch(e){}
      return map;
    }

    function restorePlayingVideos(map){
      if(!map || !map.size) return;
      var listEl = document.getElementById('fileList');
      map.forEach(function(data, src){
        try{
          var found = Array.from(listEl.querySelectorAll('[data-url]')).find(function(n){ return n.dataset && (n.dataset.url === src || n.dataset.url === decodeURIComponent(src)); });
          if(found && found.parentElement){
            var content = found.querySelector('.thumb-content');
            if(content){
              var videoEl = data.el;
              videoEl.className = videoEl.className || 'thumb';
              videoEl.controls = true;
              videoEl.setAttribute('playsinline','');
              try{ videoEl.currentTime = data.pos || 0; }catch(e){}
              content.innerHTML = '';
              content.appendChild(videoEl);
              try{ var p = videoEl.play(); if(p && p.catch) p.catch(function(){}); }catch(e){}
              return;
            }
          }
          var fallbackCard = document.createElement('div'); fallbackCard.className = 'card';
          var info = document.createElement('div'); info.className = 'info'; info.textContent = 'Vidéo (restaurée) — ' + (src||'');
          var v = data.el; v.className = 'thumb'; v.controls = true; v.setAttribute('playsinline','');
          try{ v.currentTime = data.pos || 0; }catch(e){}
          fallbackCard.appendChild(v); fallbackCard.appendChild(info);
          listEl.insertBefore(fallbackCard, listEl.firstChild);
        }catch(e){}
      });
    }

    function renderChunked(files){
      var listEl = document.getElementById('fileList');
      var preserved = snapshotPlayingVideos();
      listEl.innerHTML = '';
      var source = buildOrderedList(files || []);
      var frag = document.createDocumentFragment();
      for(var i=0;i<source.length;i++){
        var item = source[i];
        if(item.__groupHeader || item.__seasonHeader){ frag.appendChild(createCardElement(item)); continue; }
        var node = createCardElement(item);
        frag.appendChild(node);
      }
      listEl.appendChild(frag);
      restorePlayingVideos(preserved);
      updateEmpty();
      ensureSentinel();
    }

    function updateEmpty(){
      var empty = document.getElementById('emptyMessage');
      var len = (window.viewFiles && window.viewFiles.length) ? window.viewFiles.filter(function(x){ return !x.__groupHeader; }).length : buildOrderedList(window.allFiles||[]).filter(function(x){ return !x.__groupHeader; }).length;
      empty.style.display = (len === 0) ? 'block' : 'none';
    }

    window.allFiles = [];
    window.viewFiles = [];

    async function loadFiles(){
      try{
        var res = await fetch(CONFIG.FILES_PATH, { cache:'no-store' });
        if(!res.ok) throw new Error('fetch failed');
        var data = await res.json();
        var files = [];
        if(Array.isArray(data)){
          data.forEach(function(f){ var key = f.key || f.name || ''; files.push({ name: normalizeKeyName(key), originalName: key, url: f.url || '', size: Number(f.size) || 0, lastModified: Number(f.lastModified || Date.now()), key: f.key || null }); });
        } else if(data && data.ok && Array.isArray(data.result)){
          data.result.forEach(function(bucket){ if(bucket && Array.isArray(bucket.objects)) bucket.objects.forEach(function(o){ var key = o.key || o.name || ''; files.push({ name: normalizeKeyName(key), originalName: key, url: o.url || '', size: Number(o.size) || 0, lastModified: Number(o.lastModified || Date.now()), key: o.key || null }); }); });
        } else if(data && Array.isArray(data.objects)){
          data.objects.forEach(function(o){ var key = o.key || o.name || ''; files.push({ name: normalizeKeyName(key), originalName: key, url: o.url || '', size: Number(o.size) || 0, lastModified: Number(o.lastModified || Date.now()), key: o.key || null }); });
        }
        var byName = new Map();
        files.forEach(function(it){ if(!it.url) return; var n = normalizeKeyName(it.originalName || it.name || ''); if(!byName.has(n) || (byName.get(n).lastModified < it.lastModified)) byName.set(n, it); });
        var unique = Array.from(byName.values());
        unique.sort(function(a,b){ return Number(b.lastModified || 0) - Number(a.lastModified || 0); });
        window.allFiles = unique.slice(0, CONFIG.METADATA_CAP);
        renderChunked(window.allFiles);
      }catch(e){}
    }

    loadFiles();
    setInterval(loadFiles, CONFIG.POLL_INTERVAL_MS);

    var searchInput = document.getElementById('searchInput');
    function applySearch(){
      var q = (searchInput.value || '').trim().toLowerCase();
      if(!q){ window.viewFiles = []; renderChunked(window.allFiles); return; }
      var ordered = buildOrderedList(window.allFiles || []);
      window.viewFiles = ordered.filter(function(f){
        if(f.__groupHeader) return (f.base||'').toLowerCase().indexOf(q) !== -1;
        return ((f.name||'').toLowerCase().indexOf(q) !== -1) || ((f.url||'').toLowerCase().indexOf(q) !== -1) || (parseParts(f.name||'').base||'').toLowerCase().indexOf(q) !== -1;
      });
      renderChunked(window.viewFiles);
    }
    var debounceTimer = null;
    searchInput.addEventListener('input', function(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(applySearch, 140); });

    function ensureSentinel(){ var listEl = document.getElementById('fileList'); var sentinel = document.getElementById('render-sentinel'); if(!sentinel){ sentinel = document.createElement('div'); sentinel.id = 'render-sentinel'; sentinel.style.width='1px'; sentinel.style.height='1px'; sentinel.style.opacity='0'; listEl.appendChild(sentinel); } else listEl.appendChild(sentinel); }

    document.addEventListener('gesturestart', function(e){ try{ e.preventDefault(); }catch(e){} });
    document.addEventListener('touchmove', function(e){ try{ if(e.scale !== undefined && e.scale !== 1) e.preventDefault(); }catch(e){} }, { passive:false });

  })();
  </script>
</body>
  </html>
